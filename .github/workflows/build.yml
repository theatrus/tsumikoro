name: Build All Firmware

# IMPORTANT: Keep CI targets in sync with firmware/Makefile!
# When adding/removing firmware targets, update both:
# - .github/workflows/build.yml (this file)
# - firmware/Makefile (build and flash targets)
#
# Current STM32 targets:
# - tsumikoro-ministepper (STM32G071G8U6)
# - tsumikoro-servo (STM32G030F6P6)
# - nucleo-g071rb (STM32G071RBT6, bare-metal)
# - nucleo-g071rb-freertos (STM32G071RBT6, FreeRTOS)
#
# Current ESP32 targets:
# - tsumikoro-bridge (ESP32-S3)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-protocol:
    name: Test Tsumikoro Bus Protocol
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install GCC
        run: sudo apt-get update && sudo apt-get install -y gcc make

      - name: Build and run tests
        working-directory: firmware/shared/tsumikoro_bus/tests
        run: make test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: protocol-test-results
          path: firmware/shared/tsumikoro_bus/tests/*.log
          retention-days: 7
          if-no-files-found: ignore

  build-stm32-ministepper:
    name: Build STM32 Mini Stepper (G071)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup ARM GCC toolchain
        uses: carlosperate/arm-none-eabi-gcc-action@v1
        with:
          release: '13.3.Rel1'

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build

      - name: Configure CMake
        working-directory: firmware
        run: |
          mkdir -p build/ministepper-g071
          cd build/ministepper-g071
          cmake ../.. -G Ninja -DPROJECT=tsumikoro-ministepper -DMCU=STM32G071 -DCMAKE_BUILD_TYPE=Release

      - name: Build firmware
        working-directory: firmware/build/ministepper-g071
        run: ninja

      - name: Display build info
        working-directory: firmware/build/ministepper-g071
        run: |
          ls -lh tsumikoro-ministepper/tsumikoro-ministepper.*
          arm-none-eabi-size tsumikoro-ministepper/tsumikoro-ministepper.elf

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ministepper-firmware
          path: |
            firmware/build/ministepper-g071/tsumikoro-ministepper/tsumikoro-ministepper.elf
            firmware/build/ministepper-g071/tsumikoro-ministepper/tsumikoro-ministepper.bin
            firmware/build/ministepper-g071/tsumikoro-ministepper/tsumikoro-ministepper.hex
          retention-days: 30

  build-stm32-servo:
    name: Build STM32 Servo (G030)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup ARM GCC toolchain
        uses: carlosperate/arm-none-eabi-gcc-action@v1
        with:
          release: '13.3.Rel1'

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build

      - name: Configure CMake
        working-directory: firmware
        run: |
          mkdir -p build/servo-g030
          cd build/servo-g030
          cmake ../.. -G Ninja -DPROJECT=tsumikoro-servo -DMCU=STM32G030 -DCMAKE_BUILD_TYPE=Release

      - name: Build firmware
        working-directory: firmware/build/servo-g030
        run: ninja

      - name: Display build info
        working-directory: firmware/build/servo-g030
        run: |
          ls -lh tsumikoro-servo/tsumikoro-servo.*
          arm-none-eabi-size tsumikoro-servo/tsumikoro-servo.elf

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: servo-firmware
          path: |
            firmware/build/servo-g030/tsumikoro-servo/tsumikoro-servo.elf
            firmware/build/servo-g030/tsumikoro-servo/tsumikoro-servo.bin
            firmware/build/servo-g030/tsumikoro-servo/tsumikoro-servo.hex
          retention-days: 30

  build-nucleo-g071rb:
    name: Build NUCLEO-G071RB (bare-metal)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup ARM GCC toolchain
        uses: carlosperate/arm-none-eabi-gcc-action@v1
        with:
          release: '13.3.Rel1'

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build

      - name: Configure CMake
        working-directory: firmware
        run: |
          mkdir -p build/nucleo-g071rb
          cd build/nucleo-g071rb
          cmake ../.. -G Ninja -DPROJECT=nucleo-g071rb -DMCU=STM32G071 -DCMAKE_BUILD_TYPE=Release

      - name: Build firmware
        working-directory: firmware/build/nucleo-g071rb
        run: ninja

      - name: Display build info
        working-directory: firmware/build/nucleo-g071rb
        run: |
          ls -lh nucleo-g071rb/nucleo-g071rb.*
          arm-none-eabi-size nucleo-g071rb/nucleo-g071rb.elf

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nucleo-g071rb-firmware
          path: |
            firmware/build/nucleo-g071rb/nucleo-g071rb/nucleo-g071rb.elf
            firmware/build/nucleo-g071rb/nucleo-g071rb/nucleo-g071rb.bin
            firmware/build/nucleo-g071rb/nucleo-g071rb/nucleo-g071rb.hex
          retention-days: 30

  build-nucleo-g071rb-freertos:
    name: Build NUCLEO-G071RB (FreeRTOS)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup ARM GCC toolchain
        uses: carlosperate/arm-none-eabi-gcc-action@v1
        with:
          release: '13.3.Rel1'

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build

      - name: Configure CMake
        working-directory: firmware
        run: |
          mkdir -p build/nucleo-g071rb-freertos
          cd build/nucleo-g071rb-freertos
          cmake ../.. -G Ninja -DPROJECT=nucleo-g071rb-freertos -DMCU=STM32G071 -DCMAKE_BUILD_TYPE=Release

      - name: Build firmware
        working-directory: firmware/build/nucleo-g071rb-freertos
        run: ninja

      - name: Display build info
        working-directory: firmware/build/nucleo-g071rb-freertos
        run: |
          ls -lh nucleo-g071rb-freertos/nucleo-g071rb-freertos.*
          arm-none-eabi-size nucleo-g071rb-freertos/nucleo-g071rb-freertos.elf

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nucleo-g071rb-freertos-firmware
          path: |
            firmware/build/nucleo-g071rb-freertos/nucleo-g071rb-freertos/nucleo-g071rb-freertos.elf
            firmware/build/nucleo-g071rb-freertos/nucleo-g071rb-freertos/nucleo-g071rb-freertos.bin
            firmware/build/nucleo-g071rb-freertos/nucleo-g071rb-freertos/nucleo-g071rb-freertos.hex
          retention-days: 30

  build-esp32-bridge:
    name: Build ESP32 Bridge (S3)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Setup and install dependencies
        working-directory: firmware/tsumikoro-bridge
        run: make recreate-venv

      - name: Create test secrets
        working-directory: firmware/tsumikoro-bridge/esphome
        run: |
          cat > secrets.yaml << 'EOF'
          # CI build secrets
          wifi_ssid: "TestWiFi"
          wifi_password: "testpassword123"
          api_encryption_key: "NGktUgKgLcuX/DAceUzzGMLTQiViSbh4vih3uvIdI/s="
          ota_password: "testota123"
          ap_password: "testap123"
          EOF

      - name: Validate ESPHome config
        working-directory: firmware/tsumikoro-bridge
        run: uv run esphome config esphome/tsumikoro-bridge.yaml

      - name: Build firmware
        working-directory: firmware/tsumikoro-bridge
        run: uv run esphome compile esphome/tsumikoro-bridge.yaml

      - name: Display build info
        working-directory: firmware/tsumikoro-bridge
        run: |
          find esphome/.esphome/build -name "*.bin" -exec ls -lh {} \;

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: esp32-bridge-firmware
          path: |
            firmware/tsumikoro-bridge/esphome/.esphome/build/tsumikoro-bridge/.pioenvs/tsumikoro-bridge/firmware.bin
            firmware/tsumikoro-bridge/esphome/.esphome/build/tsumikoro-bridge/.pioenvs/tsumikoro-bridge/bootloader.bin
            firmware/tsumikoro-bridge/esphome/.esphome/build/tsumikoro-bridge/.pioenvs/tsumikoro-bridge/partitions.bin
          retention-days: 30
